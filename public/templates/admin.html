<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Admin Panel</title>
        <style>
            .video-container {
                display: flex;
                flex-wrap: wrap;
            }
            .video-container video {
                width: 300px;
                margin: 10px;
            }
        </style>
    </head>
    <body>
        <h1>Admin Panel - User Streams</h1>
        <div class="video-container" id="videoContainer"></div>

        <script src="/socket.io/socket.io.js"></script>
        <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
        <script>
            const socket = io();
            const videoContainer = document.getElementById("videoContainer");
            let peerConnections = {};

            function createPeerConnection(userId, offer) {
                const peerConnection = new RTCPeerConnection({
                    iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
                });

                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit("ice-candidate", {
                            userId,
                            candidate: event.candidate,
                        });
                    }
                };

                peerConnection.ontrack = (event) => {
                    const remoteVideo = document.createElement("video");
                    remoteVideo.id = `video-${userId}`;
                    remoteVideo.srcObject = event.streams[0];
                    remoteVideo.autoplay = true;
                    remoteVideo.playsinline = true;
                    videoContainer.appendChild(remoteVideo);
                };

                peerConnection
                    .setRemoteDescription(new RTCSessionDescription(offer))
                    .then(() => peerConnection.createAnswer())
                    .then((answer) =>
                        peerConnection.setLocalDescription(answer)
                    )
                    .then(() =>
                        socket.emit("answer", {
                            userId,
                            answer: peerConnection.localDescription,
                        })
                    );

                peerConnections[userId] = peerConnection;
            }

            socket.on("user-connected", ({ userId, offer }) => {
                createPeerConnection(userId, offer);
            });

            socket.on("answer", ({ userId, answer }) => {
                peerConnections[userId].setRemoteDescription(
                    new RTCSessionDescription(answer)
                );
            });

            socket.on("ice-candidate", ({ userId, candidate }) => {
                const iceCandidate = new RTCIceCandidate(candidate);
                peerConnections[userId].addIceCandidate(iceCandidate);
            });

            socket.on("user-disconnected", (userId) => {
                if (peerConnections[userId]) {
                    peerConnections[userId].close();
                    delete peerConnections[userId];
                    const videoElement = document.getElementById(
                        `video-${userId}`
                    );
                    if (videoElement) {
                        videoContainer.removeChild(videoElement);
                    }
                }
            });
        </script>
    </body>
</html>
